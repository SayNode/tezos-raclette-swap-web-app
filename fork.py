from pytezos import pytezos
from pprint import pprint
from decouple import config
import json
import time
import math

priv_key = config('priv_key')

pytezos = pytezos.using(shell='https://ghostnet.tezos.marigold.dev/', 
                        key=priv_key)

#Variable
decimals = 10**18
#Import contracts
tokenx_address = 'KT1AR4CSxb15uFKacgKDGmPDSSvBLZ5m1Fz7'
tokeny_address = 'KT1V6MLV1xN5yMhaF3jywm87Y4Vqi5fiPpxA'
cfmm_address ='KT1TZTkhnZFPL7cdNaif9B3r5oQswM1pnCXB'
wallet_address='tz1eLA1kphjGGVP7iSABmEw5U7YChT88RZSW'


ctez_burn_fee_bps= 5
fee_bps = 10
tick_spacing = 1 
x_token_address = 'KT1AR4CSxb15uFKacgKDGmPDSSvBLZ5m1Fz7'
x_token_id = 0
y_token_address = 'KT1V6MLV1xN5yMhaF3jywm87Y4Vqi5fiPpxA'
y_token_id= 0
initial_price = 5
#ladder = {(17, False): (-95, 56449132412055094618915006)}
ladder= {(0, False) : (-84, 19341845997356488514015570),
(0, True) : (-85, 38687560557337355742483221),
(1, False) : (-81, 2417609866154190654524678),
(1, True) : (-85, 38689494983725479307861971),
(2, False) : (-85, 38677889876083546261210550),
(2, True) : (-85, 38693364126677775184793561),
(3, False) : (-85, 38670155071614559132217310),
(3, True) : (-85, 38701103573421987005215721),
(4, False) : (-84, 19327345051392939314248854),
(4, True) : (-85, 38716587111352494729706462),
(5, False) : (-84, 19311889358453304431405214),
(5, True) : (-85, 38747572773653928660613512),
(6, False) : (-86, 77124060166079386301517011),
(6, True) : (-85, 38809618513447185627569983),
(7, False) : (-85, 38438828813936263312862610),
(7, True) : (-85, 38934008210058939100663682),
(8, False) : (-86, 76387211720013513967242610),
(8, True) : (-85, 39183984934869404935943141),
(9, False) : (-86, 75415686436335201065707301),
(9, True) : (-85, 39688763633815974521145659),
(10, False) : (-86, 73509547540888574991368714),
(10, True) : (-85, 40717912888646086984030507),
(11, False) : (-84, 17460146398643019245576278),
(11, True) : (-85, 42856962434838368098529959),
(12, False) : (-87, 126085780994910985395717054),
(12, True) : (-85, 47478079282778087338933597),
(13, False) : (-87, 102735988268212419722671870),
(13, True) : (-84, 29134438707490415855866100),
(14, False) : (-87, 68208042073114503830679361),
(14, True) : (-84, 43882733799120415566608322),
(15, False) : (-88, 60130046442422405275353178),
(15, True) : (-83, 49778031622173924435819796),
(16, False) : (-88, 11682706336100247487260846),
(16, True) : (-80, 32025492072892644517427309),
(17, False) : (-95, 56449132412055094618915006),
(17, True) : (-76, 53023938993515524338629870),
(18, False) : (-103, 20592303012757789234393034),
(18, True) : (-66, 36338278329035183585718600),
(19, False) : (-118, 1370156647050591448120178),
(19, True) : (-47, 34133361681864713959105863)}
cummulative_map = {0:((0,0),(0,0),"1970-01-01T00:00:00Z")}

meta_data = {"": "0x74657a6f732d73746f726167653a7375625f6d65746164617461",
            "sub_metadata": "0x7b22686f6d6570616765223a2268747470733a2f2f6769746875622e636f6d2f74657a6f732d636865636b65722f7365676d656e7465642d63666d6d222c22696e7465726661636573223a5b22545a49502d3136225d2c227669657773223a5b7b22696d706c656d656e746174696f6e73223a5b7b226d696368656c736f6e53746f7261676556696577223a7b2272657475726e54797065223a7b227072696d223a226e6174227d2c22636f6465223a5b7b227072696d223a22434152227d2c7b227072696d223a22434452227d2c7b227072696d223a22434452227d2c7b227072696d223a22434152227d5d7d7d5d2c226e616d65223a226765745f6c6971756964697479222c2270757265223a747275652c226465736372697074696f6e223a2247657420746865206c6971756964697479206f66206120746f6b656e227d2c7b22696d706c656d656e746174696f6e73223a5b7b226d696368656c736f6e53746f7261676556696577223a7b2272657475726e54797065223a7b227072696d223a226e6174227d2c22636f6465223a5b7b227072696d223a22434452227d2c7b227072696d223a22434152227d2c7b227072696d223a22434452227d2c7b227072696d223a22434452227d5d7d7d5d2c226e616d65223a226765745f737172745f7072696365222c2270757265223a747275652c226465736372697074696f6e223a22476574207468652073717561726520726f6f74206f66207669727475616c207072696365227d2c7b22696d706c656d656e746174696f6e73223a5b7b226d696368656c736f6e53746f7261676556696577223a7b2272657475726e54797065223a7b227072696d223a2261646472657373227d2c22636f6465223a5b7b227072696d223a22434152227d2c7b227072696d223a22434152227d2c7b227072696d223a22434152227d2c7b227072696d223a22434152227d2c7b227072696d223a22434152227d2c7b227072696d223a22434452227d2c7b227072696d223a22434452227d5d7d7d5d2c226e616d65223a226765745f746f6b656e5f785f61646472657373222c2270757265223a747275652c226465736372697074696f6e223a22476574207468652061646472657373206f6620746f6b656e2058227d2c7b22696d706c656d656e746174696f6e73223a5b7b226d696368656c736f6e53746f7261676556696577223a7b2272657475726e54797065223a7b227072696d223a2261646472657373227d2c22636f6465223a5b7b227072696d223a22434152227d2c7b227072696d223a22434152227d2c7b227072696d223a22434152227d2c7b227072696d223a22434152227d2c7b227072696d223a22434452227d2c7b227072696d223a22434152227d2c7b227072696d223a22434452227d5d7d7d5d2c226e616d65223a226765745f746f6b656e5f795f61646472657373222c2270757265223a747275652c226465736372697074696f6e223a22476574207468652061646472657373206f6620746f6b656e2059227d5d2c22617574686f7273223a5b225365726f6b656c6c222c224172746875722042726569746d616e225d2c226e616d65223a225365676d656e7465642043464d4d20436f6e74726163742028546f6b656e58202f20546f6b656e5929222c2276657273696f6e223a22302e302e312e30222c226c6963656e7365223a7b226e616d65223a224d4954227d2c226465736372697074696f6e223a224120636f6e7374616e742070726f64756374206d61726b6574206d616b696e6720736d6172742d636f6e74726163742c20776869636820616c6c6f77732074686520637572766520746f20626520646566696e6564206f6e207072696365207365676d656e74732e204261736564206f6e207468652069646561732064657363726962656420696e2068747470733a2f2f756e69737761702e6f72672f776869746570617065722d76332e7064662e227d"}

ticks = {-1048575: ((0,0), 0, 1, 1048575, -1048575, 0, 0, 20, 0),
        1048575: ((0,0), 0, 1, 1048575, -1048575, 0, 0, 71107673757466966990985103421469892397199512717, 0)}

def fork(ctez_burn_fee_bps, fee_bps, 
        tick_spacing, 
        x_token_address, x_token_id,
        y_token_address, y_token_id,
        initial_price,
        ladder,
        cummulative_map, 
        meta_data, 
        ticks):
    cfmm = pytezos.contract(cfmm_address)
    #initial_storage = cfmm.storage()
    initial_storage = {'constants': {'ctez_burn_fee_bps': ctez_burn_fee_bps,
                                    'fee_bps': fee_bps,
                                    'tick_spacing': tick_spacing,
                                    'x_token_address': x_token_address,
                                    'x_token_id': x_token_id,
                                    'y_token_address': y_token_address,
                                    'y_token_id': y_token_id},
                        'cumulatives_buffer': {'first': 0,
                                                'last': 0,
                                                'map': cummulative_map,
                                                'reserved_length': 1},
                        'cur_tick_index': int(round(math.log(math.sqrt(initial_price),math.sqrt(1.0001)))),
                        'cur_tick_witness': -1048575,
                        'fee_growth': {'x': 0, 'y': 0},
                        'ladder': ladder,
                        'liquidity': 0,
                        'metadata': meta_data,
                        'new_position_id': 0,
                        'operators': {},
                        'positions': {},
                        'sqrt_price': int(round(math.sqrt(initial_price)*2**80)),
                        'ticks': ticks}
    pprint(initial_storage)
    tx = pytezos.origination(cfmm.script(initial_storage)).send()
    # print(tx['originated_contracts'])

fork(ctez_burn_fee_bps, fee_bps, 
        tick_spacing, 
        x_token_address, x_token_id,
        y_token_address, y_token_id,
        initial_price, 
        ladder, 
        cummulative_map,
        meta_data,
        ticks)    

